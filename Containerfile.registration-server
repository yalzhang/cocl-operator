# Based on ./operator/register-server/Containerfile
# SPDX-FileCopyrightText: Jakob Naucke <jnaucke@redhat.com>
#
# SPDX-License-Identifier: CC0-1.0

ARG build_type
FROM quay.io/redhat-user-workloads/cocl-operator-tenant/buildroot:latest AS builder
ARG build_type
WORKDIR /build

# Drift detection - ensure local build matches upstream
COPY drift-detection/detector.sh /detector.sh
COPY drift-cache /drift-cache
WORKDIR /tmp
COPY operator/register-server/Containerfile .
RUN /detector.sh ./Containerfile /drift-cache/register-server/Containerfile

WORKDIR /build
COPY operator/Makefile operator/Cargo.toml operator/Cargo.lock operator/go.mod operator/go.sum ./
COPY operator/api api
COPY operator/lib lib
COPY operator/register-server/Cargo.toml register-server/
COPY operator/register-server/src/lib.rs register-server/src/
COPY compute-pcrs/lib /build/compute-pcrs

# Set only required crates as members to minimize rebuilds upon changes.
# Patch compute-pcrs-lib to use local path instead of git for hermetic builds
RUN sed -i 's/members =.*/members = ["lib", "register-server"]/' Cargo.toml && \
    sed -i '/\[dev-dependencies\]/,$d' register-server/Cargo.toml && \
    sed -i 's|compute-pcrs-lib = { git = "https://github.com/trusted-execution-clusters/compute-pcrs" }|compute-pcrs-lib = { path = "compute-pcrs" }|' Cargo.toml

# Pre-build Go tools for hermetic builds (avoiding go install commands that require network)
RUN mkdir -p bin && \
    CONTROLLER_TOOLS_VERSION=$(go list -m -f '{{.Version}}' sigs.k8s.io/controller-tools) && \
    YQ_VERSION=$(go list -m -f '{{.Version}}' github.com/mikefarah/yq/v4) && \
    go build -o bin/controller-gen-${CONTROLLER_TOOLS_VERSION} sigs.k8s.io/controller-tools/cmd/controller-gen && \
    go build -o bin/yq-${YQ_VERSION} github.com/mikefarah/yq/v4

RUN make crds-rs

# In debug builds, build dependencies to avoid full rebuild.
RUN if [ "$build_type" = debug ]; then cargo build -p register-server --lib; fi

COPY operator/register-server/src register-server/src
RUN cargo build -p register-server $(if [ "$build_type" = release ]; then echo --release; fi)

FROM registry.access.redhat.com/ubi9/ubi-minimal
ARG build_type
COPY --from=builder "/build/target/$build_type/register-server" /usr/bin
EXPOSE 3030
ENTRYPOINT ["/usr/bin/register-server"]
